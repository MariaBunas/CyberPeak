<!DOCTYPE html> 
<html> 
<head> 
<title>HartƒÉ InteractivƒÉ</title>
<meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-
scale=1.0">
 
<!-- Leaflet CSS and JS --> 
<link rel="stylesheet" 
href="https://unpkg.com/leaflet/dist/leaflet.css" /> 
<link rel="stylesheet" href="style.css"> 
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> 

<!-- PapaParse CSV Parser --> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
</script>
 
<!-- <script type="text/javascript" src="script.js"></script> -->

<style> 
#map { height: 600px; width: 100%; } 
</style> 
</head> 
<body> 


<h2>üó∫Ô∏è HartƒÉ InteractivƒÉ - Cyberpeak</h2> 
<div id="map"></div> 

<script src="myGAPIscript.js"></script>
 
<script> 
// icons : 
const icons = { 
ok: L.icon({ 
iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
 iconSize: [25, 41],
 iconAnchor: [12, 41],
 popupAnchor: [1, -34],
 shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png', 
shadowSize: [41, 41] }), 
warning: L.icon({ 
iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png', 
iconSize: [25, 41], 
iconAnchor: [12, 41], 
popupAnchor: [1, -34], 
shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png', 
shadowSize: [41, 41] }), 
bad: L.icon({ 
iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', 
iconSize: [25, 41], 
iconAnchor: [12, 41], 
popupAnchor: [1, -34], 
shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png', 
shadowSize: [41, 41] }) }; 

// Initialize the map
 const map = L.map('map').setView([45.76, 21.23], 6);  // Center map as needed 

// Load tile layer (OpenStreetMap) 
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map); const legend = L.control({ position: 'bottomright' }); 

legend.onAdd = function (map) { 
const div = L.DomUtil.create('div', 'info-legend'); 
div.innerHTML = `
 <strong>Severity</strong><br> 
<div class="legend-item"><span class="dot red"></span> 
Bad</div> 
<div class="legend-item"><span class="dot yellow"></span> 
Pretty Bad</div> <div class="legend-item"><span class="dot green"></span> 
OK</div> 
`; 
return div; 
}; 
legend.addTo(map);

// üìå Citim loca»õiile din CSV »ôi adƒÉugƒÉm markerii pe hartƒÉ
// fetch('https://cyberpeak-server.onrender.com/file/locations.csv')
fetch('https://raw.githubusercontent.com/MariaBunas/Cyberpeak-Backend/refs/heads/main/locations.csv')
 .then(response => response.text())
 .then(csvText => {
     Papa.parse(csvText, {
         header: true,
         skipEmptyLines: true,
         complete: function(results) {
             results.data.forEach(row => {
                 const lat = parseFloat(row.latitude);
                 const lng = parseFloat(row.longitude);
                 const name = row.name || 'Unnamed Location';
                 const severity = (row.severity || '').toLowerCase();
                 const icon = icons[severity] || icons['ok']; 
                 const imageUrl = 'https://raw.githubusercontent.com/MariaBunas/Cyberpeak-Backend/main/uploads/' + row.image;
                 const image1Url = 'https://cyberpeak-server.onrender.com/image/' + row.image;
              
                 if (!isNaN(lat) && !isNaN(lng)) {
                     // var gdriveImgUrl = image1Url; //"not found";
                                       
                     var marker = L.marker([lat, lng], { icon : icon}).addTo(map)
                         .bindPopup(`<div id="${row.name}">
                             <strong>${name}</strong><br>
                             Severitate: ${severity} <br>
                             Imagine: ${row.image} <br>                             
                             <img id="${row.image}" src="" alt="Imagine loca»õie" width="200px">
                             </div>
                         `);
                                      
                  // "${getGdriveImgUrl(row.name, image1Url)}"
                  
                     // const fileId = getFileId("ear.jpg");//row.image);
                     // if (fileId) {
                     //     gdriveImgUrl = "https://drive.google.com/thumbnail?id=" + fileId + "&sz=w200px";
                     // }
                  
                     // var fileIdPromise = getFileId(row.image);
                     // fileIdPromise.then(url => {
                     //   gdriveImgUrl = "https://drive.google.com/thumbnail?id=" + url + "&sz=w200px";
                     //   document.getElementById(row.name).src = gdriveImgUrl;
                     //   alert(gdriveImgUrl);
                     // });
                 }
             });
         }
     });
 })
 .catch(error => console.error("Eroare la citirea loca»õiilor:", error));

 map.on('popupopen', function(e) {
     
   var htmlContent = e.popup.getContent();
   const parser = new DOMParser();
   const htmlDoc = parser.parseFromString(htmlContent, 'text/xml');
   const imageElement = htmlDoc.getElementsByTagName("img")[0];
   const divElement = htmlDoc.getElementsByTagName("div")[0];

  var fileIdPromise = getFileId(imageElement.id);
  fileIdPromise.bind(e.popup).then(url => {
   alert("Test! " + this.getContent());
   alert("Gata! " +  "https://drive.google.com/thumbnail?id=" + url + "&sz=w200px");
  });
  
  alert("New file: " + fileIdPromise);
  const url = fileIdPromise; 
   
     imageElement.src = "https://drive.google.com/thumbnail?id=" + url + "&sz=w200px";
     //divElement.style.display = "block";
     alert(imageElement.src);
     const newInnerHTML = `<div id="${divElement.id} style="display: block">                                                          
                             <img id="${imageElement.id}" src="${imageElement.src}" alt="Imagine loca»õie" width="200px">
                             </div>`;
    //this.setPopupContent(innerHTML);
    e.popup.setContent(innerHTML);
   //}
                      
   // var fileIdPromise = getFileId(imageElement.id);
   // fileIdPromise.then(url => {
   //   imageElement.src = "https://drive.google.com/thumbnail?id=" + url + "&sz=w200px";
   //   divElement.style.display = "block";
   //   alert(imageElement.src);
   //   const newInnerHTML = `<div id="${divElement.id} style="display: block">                                                          
   //                           <img id="${imageElement.id}" src="${imageElement.src}" alt="Imagine loca»õie" width="200px">
   //                           </div>
   //                       `;
   //  //this.setPopupContent(innerHTML);
   //  e.popup.setContent(innerHTML);
   // });
});
  // https://github.com/Leaflet/Leaflet/issues/8130

 
//  	// popup.setContent(`<div id="${containerID}"><p>This is a longer line of text!</p></div>`) //popupContent
//   popup.setContent(`<div id="parent-${row.name}">
//                <strong>${name}</strong><br>
//                Severitate: ${severity} <br>
//                Imagine: ${row.name} <br>                             
//                <img id="${row.name}" src="" alt="Imagine loca»õie" width="200px">
//                </div>`);
  
  // const innerHTML = document.getElementById(containerID+"-wrap").innerHTML;
  //   this.setPopupContent(innerHTML);
  //   alert(e.popup.getContent());

 
</script> 

 <div>
 <h1>Load Image from Google Drive</h1>
    
    <input type="text" id="fileName" placeholder="Enter image name">
    <button onclick="searchImage()">Load Image</button>
    
    <br><br>
    <img id="driveImage" src="" alt="Image details">

   <br><br>
  <img_none src="https://drive.google.com/uc?export=view&id=1u49KytXw5JuPgUp8boIqJYevJpzUp4Nd" alt="Google Drive Image" width="500">
   <img_none src="https://drive.google.com/thumbnail?id=1u49KytXw5JuPgUp8boIqJYevJpzUp4Nd&sz=w500" alt="Your Image Alt Text">
    
 </div>
 
<!-- Subsol gri cu buton Instagram »ôi mesaj de drepturi de autor -->
<footer class="footer">
    <div class="footer-content">
        <a href="https://www.instagram.com/cyberpeak_/" target="_blank" class="instagram-button">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram">
            Pagina de Instagram
        </a>
        <p class="copyright-text">
            Toate drepturile sunt rezervate echipei Cyberpeak, liceul C.D.Loga . Utilizarea neautorizatƒÉ a acestui material, 
            inclusiv reproducerea, distribuirea, afi»ôarea sau transmiterea oricƒÉrui con»õinut, este strict 
            interzisƒÉ fƒÉrƒÉ consim»õƒÉm√¢ntul expres al echipei noastre »ôi al coordonatoarei de proiect, 
            conform Legii nr. 8/1996 privind dreptul de autor.
        </p>
    </div>
</footer>
 
</body> 
</html>

